# HammerCloud notifications

The script `hammercloud-events` derives metrics from HammerCloud email notifications.
It then adds or modifies an annotation on a [Grafana](https://grafana.com/) instance to visualize these events.

`hammercloud-events` should be invoked from `~/.procmailrc` in an account that receives copies of the HammerCloud emails.
It will also need a [service account](https://grafana.com/docs/grafana/latest/administration/service-accounts/) to modify annotations.
Configuration is via a YAML file, specified with `-D`.
An invocation in `~/.procmailrc` might look like this:

```
:0
| /usr/local/share/gridmon/hammercloud-events -D /etc/grafana-access.yml
```

(You should probably also match on some other header fields like `To:`, `List-Id:` or `Subject:`, but if the subject doesn't match, nothing happens.)

The configuration should look like this:

```
dashboard: "83hJHE8J"
panel: 0
token: "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
endpoint: "http://localhost:3000/api/annotations"
hammercloud:
  prefixes:
    queue: "queue"
    type: "type"
  tags:
    - HammerCloud
```

This specifies who to contact (`endpoint`), how to authenticate (`token`; generated by the 'Administration' => 'Users and access' => 'Service accounts' configuration section of Grafana), which dashboard to modify (`dashboard`), which panel to add the annotation to (`panel`; 0 means it's added to the dashboard as a whole), prefixes for tags derived from the email (`hammercloud.prefixes`), and which tags to include in the annotation (`hammercloud.tags`).

The script receives each email via `stdin`, and looks for a subject line containing the likes of:

```
[TYPE] Auto-excluded PANDA-QUEUE-NAME
```

`PANDA-QUEUE-NAME` and `TYPE` are used to insert an annotation with the tags `HammerCloud`, `queue:PANDA_QUEUE_NAME` and `type:TYPE`, and any others specified in configuration.
The `Date:` header field specifies the start time of the annotation, and it is given an end time set way in the future.

Alternatively, if the subject line matches the following:

```
[TYPE] reset online PANDA-QUEUE-NAME
```

&hellip;an annotation with tags `HammerCloud`, `queue:PANDA_QUEUE_NAME` and `type:TYPE` is looked up, and given an end time from the `Date:` header field.

The message is ignored if the subject line does not match either pattern.
Regardless of whether any annotations are added or modified, the message is ultimately discarded.

The script also uses the date provided by the `Date:` header field as the start or end of the annotation.

`hammercloud-events` can also be run manually to fake an event:

```
/usr/local/share/gridmon/hammercloud-events -D /etc/grafana-access.yml -q PANDA-QUEUE-NAME -t TYPE -x
```

`-x` means an exclusion.
`-r` means a reset.
The time of the command is used as the time of the event.

You might need to permit Procmail and its child processes to connect to the annotation API:

```
sudo semanage permissive -a procmail_t
```
